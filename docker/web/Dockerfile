FROM node:22 AS node-build
WORKDIR /app

COPY package.json package-lock.json ./

RUN npm ci

#FROM python:3.11
FROM node:22
WORKDIR /app

# Copy Node.js dependencies from the build stage
#COPY --from=node-build /usr/local/lib/node_modules ./
COPY --from=node-build /app/node_modules ./node_modules

# Set up environment variables
#ENV PATH="/usr/local/lib/node_modules/.bin:$PATH"

RUN apt-get update && apt-get install --no-install-recommends --yes \
  python3.11                                                        \
  python3.11-venv                                                   \
  python3.11-dev                                                    \
  python3-pip                                                       \
  pandoc                                                            \
  texlive-latex-base                                                \
  texlive-latex-recommended                                         \
  texlive-latex-extra                                               \
  texlive-fonts-recommended                                         \
  && apt-get clean                                                  \
  && rm -rf /var/lib/apt/lists/*                                    \
  && rm -rf /usr/share/doc/* /usr/share/man/*

# One reason to do this is so we can use "python" rather than "python3" in the makefile
#RUN python3 -m venv /opt/venv \
#    && /opt/venv/bin/pip install --disable-pip-version-check --no-cache-dir --no-deps --require-hashes -r requirements.txt
RUN python3 -m venv /opt/venv

# Ensure the virtual environment is activated for future commands
ENV PATH="/opt/venv/bin:$PATH"


# Avoid ascii errors when reading files in Python
ENV LANG C.UTF-8


COPY . .

RUN make

CMD [ "node", "server.js", "80" ]

